name: Evaluation Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  schedule:
    # Nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      suite:
        description: 'Test suite to run'
        type: choice
        options:
          - smoke
          - nightly
          - release
          - weekly
        default: nightly

permissions:
  contents: read
  actions: read

env:
  STOCK_BASELINE_OUTPUT_DIR: eval/output/stock-baseline
  STOCK_BASELINE_SLICES: semantic-search,type-recovery
  RELIABILITY_OUTPUT_DIR: eval/output/reliability
  RELIABILITY_SOAK_ITERATIONS: '3'
  RELIABILITY_DEADLOCK_THRESHOLD_SECONDS: '30'
  RELIABILITY_SLO_THRESHOLDS: eval/config/reliability_slo_thresholds.json
  QUERY_SLO_OUTPUT_DIR: eval/output/query-slo
  QUERY_SLO_THRESHOLDS: eval/config/query_slo_thresholds.json
  REQUIRED_PYTHON_VERSION: '3.11'
  REQUIRED_JAVA_VERSION: '21'

jobs:
  smoke:
    name: Smoke Tests (per-commit)
    if: github.event_name == 'push' || github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.suite == 'smoke')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.REQUIRED_PYTHON_VERSION }}

      - name: Validate roadmap source-of-truth parity (blocking)
        run: bash scripts/cyntra/validate-roadmap-completion.sh

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.REQUIRED_JAVA_VERSION }}

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '8.10.2'

      - name: Verify Python + JDK toolchain versions
        run: |
          python3 --version
          python3 - <<'PY'
          import os
          import sys
          required = tuple(int(part) for part in os.environ["REQUIRED_PYTHON_VERSION"].split("."))
          current = sys.version_info[:2]
          if current != required:
              raise SystemExit(
                  f"Expected Python {required[0]}.{required[1]}, found {current[0]}.{current[1]}"
              )
          print(f"Python version OK: {current[0]}.{current[1]}")
          PY

          java_version_line="$(java -version 2>&1 | head -n 1)"
          java_version="$(sed -n 's/.*version "\(.*\)".*/\1/p' <<<"${java_version_line}")"
          if [[ -z "${java_version}" ]]; then
            echo "Unable to parse Java version from: ${java_version_line}" >&2
            exit 1
          fi
          java_major="${java_version%%.*}"
          if [[ "${java_major}" == "1" ]]; then
            java_major="$(cut -d. -f2 <<<"${java_version}")"
          fi
          if [[ "${java_major}" != "${REQUIRED_JAVA_VERSION}" ]]; then
            echo "Expected JDK ${REQUIRED_JAVA_VERSION}, found Java ${java_version}" >&2
            exit 1
          fi
          javac_version_line="$(javac -version 2>&1 | head -n 1)"
          javac_version="$(awk '{print $2}' <<<"${javac_version_line}")"
          if [[ -z "${javac_version}" ]]; then
            echo "Unable to parse javac version from: ${javac_version_line}" >&2
            exit 1
          fi
          javac_major="${javac_version%%.*}"
          if [[ "${javac_major}" == "1" ]]; then
            javac_major="$(cut -d. -f2 <<<"${javac_version}")"
          fi
          if [[ "${javac_major}" != "${REQUIRED_JAVA_VERSION}" ]]; then
            echo "Expected JDK ${REQUIRED_JAVA_VERSION}, found javac ${javac_version}" >&2
            exit 1
          fi
          if [[ "${java_major}" != "${javac_major}" ]]; then
            echo "java/javac mismatch: java=${java_version} javac=${javac_version}" >&2
            exit 1
          fi
          echo "Java toolchain OK: ${java_version_line} / ${javac_version_line}"

      - name: Run no-direct-agent-write security regression suite (blocking)
        run: |
          python3 scripts/tests/no_direct_agent_write_invariant.py \
            --output-dir scripts/tests/artifacts/no-direct-agent-write
          python3 -m unittest scripts/tests/test_no_direct_agent_write_invariant.py

      - name: Run Java regression module tests (Gradle + JDK 21, blocking)
        run: |
          java_version_line="$(java -version 2>&1 | head -n 1)"
          javac_version_line="$(javac -version 2>&1 | head -n 1)"
          echo "${java_version_line}"
          echo "${javac_version_line}"
          if ! grep -q "\"${REQUIRED_JAVA_VERSION}" <<<"${java_version_line}"; then
            echo "Expected JDK ${REQUIRED_JAVA_VERSION} for Gradle test execution" >&2
            exit 1
          fi
          if ! grep -Eq "^javac ${REQUIRED_JAVA_VERSION}(\\.|$)" <<<"${javac_version_line}"; then
            echo "Expected javac ${REQUIRED_JAVA_VERSION} for Gradle test execution" >&2
            exit 1
          fi
          gradle -p eval/java-regression --no-daemon test

      - name: Fetch Ghidra build dependencies (blocking)
        run: gradle -I gradle/support/fetchDependencies.gradle --no-daemon

      - name: Compile Generic security module (blocking)
        run: ./gradlew --no-daemon :Generic:compileJava

      - name: Run Generic security unit tests (blocking)
        run: ./gradlew --no-daemon :Generic:test --tests "ghidra.security.*"

      - name: Fail on Generic security JUnit failures (blocking)
        run: python3 scripts/cyntra/check-junit-failures.py --results-dir Ghidra/Framework/Generic/build/test-results/test

      - name: Compile Reverend module (blocking)
        run: ./gradlew --no-daemon :Reverend:compileJava

      - name: Run Reverend unit tests (blocking)
        run: ./gradlew --no-daemon :Reverend:test --tests "ghidra.reverend.*"

      - name: Fail on Reverend JUnit failures (blocking)
        run: python3 scripts/cyntra/check-junit-failures.py --results-dir Ghidra/Features/Reverend/build/test-results/test

      - name: Compile frontier modules (SoftwareModeling + Base, blocking)
        run: ./gradlew --no-daemon :SoftwareModeling:compileJava :Base:compileJava

      - name: Upload no-direct-agent-write invariant artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: no-direct-agent-write-invariant-${{ github.sha }}
          path: scripts/tests/artifacts/no-direct-agent-write/
          retention-days: 30

      - name: Run stock baseline slices (writes ${{ env.STOCK_BASELINE_OUTPUT_DIR }}/metrics.json)
        run: |
          bash eval/run_smoke.sh \
            --slice semantic-search \
            --slice type-recovery \
            --output "${STOCK_BASELINE_OUTPUT_DIR}/metrics.json"

      - name: Publish stock baseline comparator artifacts (baseline.json + baseline-report.md)
        run: |
          python3 eval/scripts/publish_baseline.py \
            --metrics "${STOCK_BASELINE_OUTPUT_DIR}/metrics.json" \
            --baseline-out "${STOCK_BASELINE_OUTPUT_DIR}/baseline.json" \
            --report-out "${STOCK_BASELINE_OUTPUT_DIR}/baseline-report.md" \
            --seed "${EVAL_SEED:-0}"

      - name: Add stock baseline summary
        if: always()
        run: |
          {
            echo "## Stock Baseline (${GITHUB_JOB})"
            echo ""
            echo "Slices: \`${STOCK_BASELINE_SLICES}\`"
            echo ""
            if [[ -f "${STOCK_BASELINE_OUTPUT_DIR}/baseline-report.md" ]]; then
              cat "${STOCK_BASELINE_OUTPUT_DIR}/baseline-report.md"
            else
              echo "_baseline report unavailable_"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Run smoke tests (writes eval/output/smoke/metrics.json)
        run: bash eval/run_smoke.sh

      - name: Check smoke metrics against baseline (writes eval/output/smoke/regression.json, blocking)
        run: |
          python3 eval/scripts/check_regression.py \
            --current eval/output/smoke/metrics.json \
            --baseline eval/snapshots/baseline.json \
            --output eval/output/smoke/regression.json

      - name: Build query SLO report (writes JSON + markdown, blocking)
        run: |
          python3 eval/scripts/query_slo_report.py \
            --metrics eval/output/smoke/metrics.json \
            --thresholds "${QUERY_SLO_THRESHOLDS}" \
            --output-json "${QUERY_SLO_OUTPUT_DIR}/slo-report.json" \
            --output-md "${QUERY_SLO_OUTPUT_DIR}/slo-report.md" \
            --fail-on-breach

      - name: Add query SLO summary
        if: always()
        run: |
          {
            echo "## Query SLO (${GITHUB_JOB})"
            echo ""
            if [[ -f "${QUERY_SLO_OUTPUT_DIR}/slo-report.md" ]]; then
              cat "${QUERY_SLO_OUTPUT_DIR}/slo-report.md"
            else
              echo "_query SLO report unavailable_"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Run reliability soak (writes ${{ env.RELIABILITY_OUTPUT_DIR }}/soak-report.json)
        run: |
          bash eval/run_soak.sh \
            --iterations "${RELIABILITY_SOAK_ITERATIONS}" \
            --deadlock-threshold-seconds "${RELIABILITY_DEADLOCK_THRESHOLD_SECONDS}" \
            --output "${RELIABILITY_OUTPUT_DIR}/soak-report.json"

      - name: Build reliability SLO report (writes JSON + markdown, blocking)
        run: |
          python3 eval/scripts/reliability_slo_report.py \
            --soak-report "${RELIABILITY_OUTPUT_DIR}/soak-report.json" \
            --thresholds "${RELIABILITY_SLO_THRESHOLDS}" \
            --output-json "${RELIABILITY_OUTPUT_DIR}/slo-report.json" \
            --output-md "${RELIABILITY_OUTPUT_DIR}/slo-report.md" \
            --fail-on-breach

      - name: Add reliability SLO summary
        if: always()
        run: |
          {
            echo "## Reliability SLO (${GITHUB_JOB})"
            echo ""
            if [[ -f "${RELIABILITY_OUTPUT_DIR}/slo-report.md" ]]; then
              cat "${RELIABILITY_OUTPUT_DIR}/slo-report.md"
            else
              echo "_reliability report unavailable_"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload smoke metrics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-metrics-${{ github.sha }}
          path: eval/output/smoke/
          retention-days: 30

      - name: Upload query SLO artifacts (smoke lane)
        id: upload_query_slo_smoke
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: query-slo-smoke-${{ github.run_id }}
          path: ${{ env.QUERY_SLO_OUTPUT_DIR }}/
          retention-days: 90
          if-no-files-found: warn

      - name: Add query SLO artifact link (smoke lane)
        if: always()
        run: |
          query_artifact_url="${{ steps.upload_query_slo_smoke.outputs['artifact-url'] }}"
          run_url="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          if [[ -z "${query_artifact_url}" ]]; then
            query_artifact_url="${run_url}"
          fi
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "Query SLO artifacts: [query-slo-smoke-${GITHUB_RUN_ID}](${query_artifact_url})" >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload reliability SLO artifacts (smoke lane)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: reliability-slo-smoke-${{ github.run_id }}
          path: ${{ env.RELIABILITY_OUTPUT_DIR }}/
          retention-days: 90

      - name: Upload stock baseline artifacts (smoke lane)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stock-baseline-smoke-${{ github.run_id }}
          path: ${{ env.STOCK_BASELINE_OUTPUT_DIR }}/
          retention-days: 90

  nightly:
    name: Nightly Regression
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.suite == 'nightly')
    runs-on: ubuntu-latest
    timeout-minutes: 300
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.REQUIRED_PYTHON_VERSION }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.REQUIRED_JAVA_VERSION }}

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '8.10.2'

      - name: Verify Python + JDK toolchain versions
        run: |
          python3 --version
          python3 - <<'PY'
          import os
          import sys
          required = tuple(int(part) for part in os.environ["REQUIRED_PYTHON_VERSION"].split("."))
          current = sys.version_info[:2]
          if current != required:
              raise SystemExit(
                  f"Expected Python {required[0]}.{required[1]}, found {current[0]}.{current[1]}"
              )
          print(f"Python version OK: {current[0]}.{current[1]}")
          PY

          java_version_line="$(java -version 2>&1 | head -n 1)"
          java_version="$(sed -n 's/.*version "\(.*\)".*/\1/p' <<<"${java_version_line}")"
          if [[ -z "${java_version}" ]]; then
            echo "Unable to parse Java version from: ${java_version_line}" >&2
            exit 1
          fi
          java_major="${java_version%%.*}"
          if [[ "${java_major}" == "1" ]]; then
            java_major="$(cut -d. -f2 <<<"${java_version}")"
          fi
          if [[ "${java_major}" != "${REQUIRED_JAVA_VERSION}" ]]; then
            echo "Expected JDK ${REQUIRED_JAVA_VERSION}, found Java ${java_version}" >&2
            exit 1
          fi
          javac_version_line="$(javac -version 2>&1 | head -n 1)"
          javac_version="$(awk '{print $2}' <<<"${javac_version_line}")"
          if [[ -z "${javac_version}" ]]; then
            echo "Unable to parse javac version from: ${javac_version_line}" >&2
            exit 1
          fi
          javac_major="${javac_version%%.*}"
          if [[ "${javac_major}" == "1" ]]; then
            javac_major="$(cut -d. -f2 <<<"${javac_version}")"
          fi
          if [[ "${javac_major}" != "${REQUIRED_JAVA_VERSION}" ]]; then
            echo "Expected JDK ${REQUIRED_JAVA_VERSION}, found javac ${javac_version}" >&2
            exit 1
          fi
          if [[ "${java_major}" != "${javac_major}" ]]; then
            echo "java/javac mismatch: java=${java_version} javac=${javac_version}" >&2
            exit 1
          fi
          echo "Java toolchain OK: ${java_version_line} / ${javac_version_line}"

      - name: Run Java regression module tests (Gradle + JDK 21, blocking)
        run: |
          java_version_line="$(java -version 2>&1 | head -n 1)"
          javac_version_line="$(javac -version 2>&1 | head -n 1)"
          echo "${java_version_line}"
          echo "${javac_version_line}"
          if ! grep -q "\"${REQUIRED_JAVA_VERSION}" <<<"${java_version_line}"; then
            echo "Expected JDK ${REQUIRED_JAVA_VERSION} for Gradle test execution" >&2
            exit 1
          fi
          if ! grep -Eq "^javac ${REQUIRED_JAVA_VERSION}(\\.|$)" <<<"${javac_version_line}"; then
            echo "Expected javac ${REQUIRED_JAVA_VERSION} for Gradle test execution" >&2
            exit 1
          fi
          gradle -p eval/java-regression --no-daemon test

      - name: Fetch Ghidra build dependencies (blocking)
        run: gradle -I gradle/support/fetchDependencies.gradle --no-daemon

      - name: Compile Generic security module (blocking)
        run: ./gradlew --no-daemon :Generic:compileJava

      - name: Run Generic security unit tests (blocking)
        run: ./gradlew --no-daemon :Generic:test --tests "ghidra.security.*"

      - name: Fail on Generic security JUnit failures (blocking)
        run: python3 scripts/cyntra/check-junit-failures.py --results-dir Ghidra/Framework/Generic/build/test-results/test

      - name: Compile Reverend module (blocking)
        run: ./gradlew --no-daemon :Reverend:compileJava

      - name: Run Reverend unit tests (blocking)
        run: ./gradlew --no-daemon :Reverend:test --tests "ghidra.reverend.*"

      - name: Fail on Reverend JUnit failures (blocking)
        run: python3 scripts/cyntra/check-junit-failures.py --results-dir Ghidra/Features/Reverend/build/test-results/test

      - name: Compile frontier modules (SoftwareModeling + Base, blocking)
        run: ./gradlew --no-daemon :SoftwareModeling:compileJava :Base:compileJava

      - name: Run stock baseline slices (writes ${{ env.STOCK_BASELINE_OUTPUT_DIR }}/metrics.json)
        run: |
          bash eval/run_smoke.sh \
            --slice semantic-search \
            --slice type-recovery \
            --output "${STOCK_BASELINE_OUTPUT_DIR}/metrics.json"

      - name: Publish stock baseline comparator artifacts (baseline.json + baseline-report.md)
        run: |
          python3 eval/scripts/publish_baseline.py \
            --metrics "${STOCK_BASELINE_OUTPUT_DIR}/metrics.json" \
            --baseline-out "${STOCK_BASELINE_OUTPUT_DIR}/baseline.json" \
            --report-out "${STOCK_BASELINE_OUTPUT_DIR}/baseline-report.md" \
            --seed "${EVAL_SEED:-0}"

      - name: Add stock baseline summary
        if: always()
        run: |
          {
            echo "## Stock Baseline (${GITHUB_JOB})"
            echo ""
            echo "Slices: \`${STOCK_BASELINE_SLICES}\`"
            echo ""
            if [[ -f "${STOCK_BASELINE_OUTPUT_DIR}/baseline-report.md" ]]; then
              cat "${STOCK_BASELINE_OUTPUT_DIR}/baseline-report.md"
            else
              echo "_baseline report unavailable_"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Run smoke tests (writes eval/output/smoke/metrics.json)
        run: bash eval/run_smoke.sh

      - name: Build query SLO report (writes JSON + markdown, blocking)
        run: |
          python3 eval/scripts/query_slo_report.py \
            --metrics eval/output/smoke/metrics.json \
            --thresholds "${QUERY_SLO_THRESHOLDS}" \
            --output-json "${QUERY_SLO_OUTPUT_DIR}/slo-report.json" \
            --output-md "${QUERY_SLO_OUTPUT_DIR}/slo-report.md" \
            --fail-on-breach

      - name: Add query SLO summary
        if: always()
        run: |
          {
            echo "## Query SLO (${GITHUB_JOB})"
            echo ""
            if [[ -f "${QUERY_SLO_OUTPUT_DIR}/slo-report.md" ]]; then
              cat "${QUERY_SLO_OUTPUT_DIR}/slo-report.md"
            else
              echo "_query SLO report unavailable_"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Run reliability soak (writes ${{ env.RELIABILITY_OUTPUT_DIR }}/soak-report.json)
        run: |
          bash eval/run_soak.sh \
            --iterations "${RELIABILITY_SOAK_ITERATIONS}" \
            --deadlock-threshold-seconds "${RELIABILITY_DEADLOCK_THRESHOLD_SECONDS}" \
            --output "${RELIABILITY_OUTPUT_DIR}/soak-report.json"

      - name: Build reliability SLO report (writes JSON + markdown, blocking)
        run: |
          python3 eval/scripts/reliability_slo_report.py \
            --soak-report "${RELIABILITY_OUTPUT_DIR}/soak-report.json" \
            --thresholds "${RELIABILITY_SLO_THRESHOLDS}" \
            --output-json "${RELIABILITY_OUTPUT_DIR}/slo-report.json" \
            --output-md "${RELIABILITY_OUTPUT_DIR}/slo-report.md" \
            --fail-on-breach

      - name: Add reliability SLO summary
        if: always()
        run: |
          {
            echo "## Reliability SLO (${GITHUB_JOB})"
            echo ""
            if [[ -f "${RELIABILITY_OUTPUT_DIR}/slo-report.md" ]]; then
              cat "${RELIABILITY_OUTPUT_DIR}/slo-report.md"
            else
              echo "_reliability report unavailable_"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Resolve previous nightly baseline
        id: previous_nightly
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const branch = context.ref.replace("refs/heads/", "");
            const runs = await github.paginate(
              github.rest.actions.listWorkflowRuns,
              {
                owner,
                repo,
                workflow_id: "eval.yaml",
                branch,
                status: "success",
                per_page: 100
              }
            );

            for (const run of runs) {
              if (run.id === context.runId) {
                continue;
              }
              if (run.event !== "schedule" && run.event !== "workflow_dispatch") {
                continue;
              }

              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: run.id,
                per_page: 100
              });
              const hasNightlyMetrics = artifacts.data.artifacts.some(
                (artifact) => artifact.name === "nightly-smoke-metrics" && !artifact.expired
              );
              if (hasNightlyMetrics) {
                core.setOutput("run_id", String(run.id));
                core.info(`using nightly baseline from run ${run.id} (${run.created_at})`);
                return;
              }
            }

            core.setOutput("run_id", "");
            core.info("no previous nightly baseline artifact found");

      - name: Download previous nightly smoke metrics
        if: steps.previous_nightly.outputs.run_id != ''
        uses: actions/download-artifact@v4
        with:
          name: nightly-smoke-metrics
          path: eval/output/nightly-baseline
          run-id: ${{ steps.previous_nightly.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Compare against previous nightly baseline (writes eval/output/smoke/nightly-comparison.json, blocking)
        if: steps.previous_nightly.outputs.run_id != ''
        run: |
          previous_metrics="$(find eval/output/nightly-baseline -type f -name metrics.json | head -n 1)"
          if [[ -z "${previous_metrics}" ]]; then
            echo "no metrics.json found in previous nightly baseline artifact" >&2
            exit 2
          fi
          python3 eval/scripts/compare_runs.py \
            --current eval/output/smoke/metrics.json \
            --previous "${previous_metrics}" \
            --output eval/output/smoke/nightly-comparison.json

      - name: Skip comparison when no nightly baseline exists
        if: steps.previous_nightly.outputs.run_id == ''
        run: echo "No previous nightly baseline artifact found; skipping comparison."

      - name: Upload nightly smoke baseline
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-smoke-metrics
          path: eval/output/smoke/metrics.json
          retention-days: 90

      - name: Upload nightly results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-results-${{ github.run_id }}
          path: eval/output/
          retention-days: 90

      - name: Upload query SLO artifacts (nightly lane)
        id: upload_query_slo_nightly
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: query-slo-nightly-${{ github.run_id }}
          path: ${{ env.QUERY_SLO_OUTPUT_DIR }}/
          retention-days: 90
          if-no-files-found: warn

      - name: Add query SLO artifact link (nightly lane)
        if: always()
        run: |
          query_artifact_url="${{ steps.upload_query_slo_nightly.outputs['artifact-url'] }}"
          run_url="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          if [[ -z "${query_artifact_url}" ]]; then
            query_artifact_url="${run_url}"
          fi
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "Query SLO artifacts: [query-slo-nightly-${GITHUB_RUN_ID}](${query_artifact_url})" >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload reliability SLO artifacts (nightly lane)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: reliability-slo-nightly-${{ github.run_id }}
          path: ${{ env.RELIABILITY_OUTPUT_DIR }}/
          retention-days: 90

      - name: Upload stock baseline artifacts (nightly lane)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stock-baseline-nightly-${{ github.run_id }}
          path: ${{ env.STOCK_BASELINE_OUTPUT_DIR }}/
          retention-days: 90

  release:
    name: Release Validation
    if: github.event_name == 'workflow_dispatch' && inputs.suite == 'release'
    runs-on: ubuntu-latest
    timeout-minutes: 1440
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.REQUIRED_PYTHON_VERSION }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.REQUIRED_JAVA_VERSION }}

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '8.10.2'

      - name: Verify Python + JDK toolchain versions
        run: |
          python3 --version
          python3 - <<'PY'
          import os
          import sys
          required = tuple(int(part) for part in os.environ["REQUIRED_PYTHON_VERSION"].split("."))
          current = sys.version_info[:2]
          if current != required:
              raise SystemExit(
                  f"Expected Python {required[0]}.{required[1]}, found {current[0]}.{current[1]}"
              )
          print(f"Python version OK: {current[0]}.{current[1]}")
          PY

          java_version_line="$(java -version 2>&1 | head -n 1)"
          java_version="$(sed -n 's/.*version "\(.*\)".*/\1/p' <<<"${java_version_line}")"
          if [[ -z "${java_version}" ]]; then
            echo "Unable to parse Java version from: ${java_version_line}" >&2
            exit 1
          fi
          java_major="${java_version%%.*}"
          if [[ "${java_major}" == "1" ]]; then
            java_major="$(cut -d. -f2 <<<"${java_version}")"
          fi
          if [[ "${java_major}" != "${REQUIRED_JAVA_VERSION}" ]]; then
            echo "Expected JDK ${REQUIRED_JAVA_VERSION}, found Java ${java_version}" >&2
            exit 1
          fi
          javac_version_line="$(javac -version 2>&1 | head -n 1)"
          javac_version="$(awk '{print $2}' <<<"${javac_version_line}")"
          if [[ -z "${javac_version}" ]]; then
            echo "Unable to parse javac version from: ${javac_version_line}" >&2
            exit 1
          fi
          javac_major="${javac_version%%.*}"
          if [[ "${javac_major}" == "1" ]]; then
            javac_major="$(cut -d. -f2 <<<"${javac_version}")"
          fi
          if [[ "${javac_major}" != "${REQUIRED_JAVA_VERSION}" ]]; then
            echo "Expected JDK ${REQUIRED_JAVA_VERSION}, found javac ${javac_version}" >&2
            exit 1
          fi
          if [[ "${java_major}" != "${javac_major}" ]]; then
            echo "java/javac mismatch: java=${java_version} javac=${javac_version}" >&2
            exit 1
          fi
          echo "Java toolchain OK: ${java_version_line} / ${javac_version_line}"

      - name: Run Java regression module tests (Gradle + JDK 21, blocking)
        run: |
          java_version_line="$(java -version 2>&1 | head -n 1)"
          javac_version_line="$(javac -version 2>&1 | head -n 1)"
          echo "${java_version_line}"
          echo "${javac_version_line}"
          if ! grep -q "\"${REQUIRED_JAVA_VERSION}" <<<"${java_version_line}"; then
            echo "Expected JDK ${REQUIRED_JAVA_VERSION} for Gradle test execution" >&2
            exit 1
          fi
          if ! grep -Eq "^javac ${REQUIRED_JAVA_VERSION}(\\.|$)" <<<"${javac_version_line}"; then
            echo "Expected javac ${REQUIRED_JAVA_VERSION} for Gradle test execution" >&2
            exit 1
          fi
          gradle -p eval/java-regression --no-daemon test

      - name: Fetch Ghidra build dependencies (blocking)
        run: gradle -I gradle/support/fetchDependencies.gradle --no-daemon

      - name: Compile Generic security module (blocking)
        run: ./gradlew --no-daemon :Generic:compileJava

      - name: Run Generic security unit tests (blocking)
        run: ./gradlew --no-daemon :Generic:test --tests "ghidra.security.*"

      - name: Fail on Generic security JUnit failures (blocking)
        run: python3 scripts/cyntra/check-junit-failures.py --results-dir Ghidra/Framework/Generic/build/test-results/test

      - name: Compile Reverend module (blocking)
        run: ./gradlew --no-daemon :Reverend:compileJava

      - name: Run Reverend unit tests (blocking)
        run: ./gradlew --no-daemon :Reverend:test --tests "ghidra.reverend.*"

      - name: Fail on Reverend JUnit failures (blocking)
        run: python3 scripts/cyntra/check-junit-failures.py --results-dir Ghidra/Features/Reverend/build/test-results/test

      - name: Compile frontier modules (SoftwareModeling + Base, blocking)
        run: ./gradlew --no-daemon :SoftwareModeling:compileJava :Base:compileJava

      - name: Run stock baseline slices (writes ${{ env.STOCK_BASELINE_OUTPUT_DIR }}/metrics.json)
        run: |
          bash eval/run_smoke.sh \
            --slice semantic-search \
            --slice type-recovery \
            --output "${STOCK_BASELINE_OUTPUT_DIR}/metrics.json"

      - name: Publish stock baseline comparator artifacts (baseline.json + baseline-report.md)
        run: |
          python3 eval/scripts/publish_baseline.py \
            --metrics "${STOCK_BASELINE_OUTPUT_DIR}/metrics.json" \
            --baseline-out "${STOCK_BASELINE_OUTPUT_DIR}/baseline.json" \
            --report-out "${STOCK_BASELINE_OUTPUT_DIR}/baseline-report.md" \
            --seed "${EVAL_SEED:-0}"

      - name: Add stock baseline summary
        if: always()
        run: |
          {
            echo "## Stock Baseline (${GITHUB_JOB})"
            echo ""
            echo "Slices: \`${STOCK_BASELINE_SLICES}\`"
            echo ""
            if [[ -f "${STOCK_BASELINE_OUTPUT_DIR}/baseline-report.md" ]]; then
              cat "${STOCK_BASELINE_OUTPUT_DIR}/baseline-report.md"
            else
              echo "_baseline report unavailable_"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Run smoke tests (writes eval/output/smoke/metrics.json)
        run: bash eval/run_smoke.sh

      - name: Check smoke metrics against baseline (writes eval/output/smoke/release-regression.json, blocking)
        run: |
          python3 eval/scripts/check_regression.py \
            --current eval/output/smoke/metrics.json \
            --baseline eval/snapshots/baseline.json \
            --output eval/output/smoke/release-regression.json

      - name: Build query SLO report (writes JSON + markdown, blocking)
        run: |
          python3 eval/scripts/query_slo_report.py \
            --metrics eval/output/smoke/metrics.json \
            --thresholds "${QUERY_SLO_THRESHOLDS}" \
            --output-json "${QUERY_SLO_OUTPUT_DIR}/slo-report.json" \
            --output-md "${QUERY_SLO_OUTPUT_DIR}/slo-report.md" \
            --fail-on-breach

      - name: Add query SLO summary
        if: always()
        run: |
          {
            echo "## Query SLO (${GITHUB_JOB})"
            echo ""
            if [[ -f "${QUERY_SLO_OUTPUT_DIR}/slo-report.md" ]]; then
              cat "${QUERY_SLO_OUTPUT_DIR}/slo-report.md"
            else
              echo "_query SLO report unavailable_"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Run reliability soak (writes ${{ env.RELIABILITY_OUTPUT_DIR }}/soak-report.json)
        run: |
          bash eval/run_soak.sh \
            --iterations "${RELIABILITY_SOAK_ITERATIONS}" \
            --deadlock-threshold-seconds "${RELIABILITY_DEADLOCK_THRESHOLD_SECONDS}" \
            --output "${RELIABILITY_OUTPUT_DIR}/soak-report.json"

      - name: Build reliability SLO report (writes JSON + markdown, blocking)
        run: |
          python3 eval/scripts/reliability_slo_report.py \
            --soak-report "${RELIABILITY_OUTPUT_DIR}/soak-report.json" \
            --thresholds "${RELIABILITY_SLO_THRESHOLDS}" \
            --output-json "${RELIABILITY_OUTPUT_DIR}/slo-report.json" \
            --output-md "${RELIABILITY_OUTPUT_DIR}/slo-report.md" \
            --fail-on-breach

      - name: Add reliability SLO summary
        if: always()
        run: |
          {
            echo "## Reliability SLO (${GITHUB_JOB})"
            echo ""
            if [[ -f "${RELIABILITY_OUTPUT_DIR}/slo-report.md" ]]; then
              cat "${RELIABILITY_OUTPUT_DIR}/slo-report.md"
            else
              echo "_reliability report unavailable_"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload release results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-results-${{ github.run_id }}
          path: eval/output/
          retention-days: 365

      - name: Upload query SLO artifacts (release lane)
        id: upload_query_slo_release
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: query-slo-release-${{ github.run_id }}
          path: ${{ env.QUERY_SLO_OUTPUT_DIR }}/
          retention-days: 365
          if-no-files-found: warn

      - name: Add query SLO artifact link (release lane)
        if: always()
        run: |
          query_artifact_url="${{ steps.upload_query_slo_release.outputs['artifact-url'] }}"
          run_url="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          if [[ -z "${query_artifact_url}" ]]; then
            query_artifact_url="${run_url}"
          fi
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "Query SLO artifacts: [query-slo-release-${GITHUB_RUN_ID}](${query_artifact_url})" >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload reliability SLO artifacts (release lane)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: reliability-slo-release-${{ github.run_id }}
          path: ${{ env.RELIABILITY_OUTPUT_DIR }}/
          retention-days: 365

      - name: Upload stock baseline artifacts (release lane)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stock-baseline-release-${{ github.run_id }}
          path: ${{ env.STOCK_BASELINE_OUTPUT_DIR }}/
          retention-days: 365
