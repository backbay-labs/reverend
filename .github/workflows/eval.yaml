name: Evaluation Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  schedule:
    # Nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      suite:
        description: 'Test suite to run'
        type: choice
        options:
          - smoke
          - nightly
          - release
          - weekly
        default: nightly

permissions:
  contents: read
  actions: read

jobs:
  smoke:
    name: Smoke Tests (per-commit)
    if: github.event_name == 'push' || github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.suite == 'smoke')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run smoke tests
        run: bash eval/run_smoke.sh

      - name: Check smoke metrics against baseline (blocking)
        run: |
          python3 eval/scripts/check_regression.py \
            --current eval/output/smoke/metrics.json \
            --baseline eval/snapshots/baseline.json \
            --output eval/output/smoke/regression.json

      - name: Upload smoke metrics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-metrics-${{ github.sha }}
          path: eval/output/smoke/
          retention-days: 30

  nightly:
    name: Nightly Regression
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.suite == 'nightly')
    runs-on: ubuntu-latest
    timeout-minutes: 300
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Run smoke tests (generate current metrics)
        run: bash eval/run_smoke.sh

      - name: Resolve previous nightly baseline
        id: previous_nightly
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const branch = context.ref.replace("refs/heads/", "");
            const runs = await github.paginate(
              github.rest.actions.listWorkflowRuns,
              {
                owner,
                repo,
                workflow_id: "eval.yaml",
                branch,
                status: "success",
                per_page: 100
              }
            );

            for (const run of runs) {
              if (run.id === context.runId) {
                continue;
              }
              if (run.event !== "schedule" && run.event !== "workflow_dispatch") {
                continue;
              }

              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: run.id,
                per_page: 100
              });
              const hasNightlyMetrics = artifacts.data.artifacts.some(
                (artifact) => artifact.name === "nightly-smoke-metrics" && !artifact.expired
              );
              if (hasNightlyMetrics) {
                core.setOutput("run_id", String(run.id));
                core.info(`using nightly baseline from run ${run.id} (${run.created_at})`);
                return;
              }
            }

            core.setOutput("run_id", "");
            core.info("no previous nightly baseline artifact found");

      - name: Download previous nightly smoke metrics
        if: steps.previous_nightly.outputs.run_id != ''
        uses: actions/download-artifact@v4
        with:
          name: nightly-smoke-metrics
          path: eval/output/nightly-baseline
          run-id: ${{ steps.previous_nightly.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Compare against previous nightly baseline (blocking)
        if: steps.previous_nightly.outputs.run_id != ''
        run: |
          previous_metrics="$(find eval/output/nightly-baseline -type f -name metrics.json | head -n 1)"
          if [[ -z "${previous_metrics}" ]]; then
            echo "no metrics.json found in previous nightly baseline artifact" >&2
            exit 2
          fi
          python3 eval/scripts/compare_runs.py \
            --current eval/output/smoke/metrics.json \
            --previous "${previous_metrics}" \
            --output eval/output/smoke/nightly-comparison.json

      - name: Skip comparison when no nightly baseline exists
        if: steps.previous_nightly.outputs.run_id == ''
        run: echo "No previous nightly baseline artifact found; skipping comparison."

      - name: Upload nightly smoke baseline
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-smoke-metrics
          path: eval/output/smoke/metrics.json
          retention-days: 90

      - name: Upload nightly results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-results-${{ github.run_id }}
          path: eval/output/
          retention-days: 90

  release:
    name: Release Validation
    if: github.event_name == 'workflow_dispatch' && inputs.suite == 'release'
    runs-on: ubuntu-latest
    timeout-minutes: 1440
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Run smoke tests
        run: bash eval/run_smoke.sh

      - name: Check smoke metrics against baseline (blocking)
        run: |
          python3 eval/scripts/check_regression.py \
            --current eval/output/smoke/metrics.json \
            --baseline eval/snapshots/baseline.json \
            --output eval/output/smoke/release-regression.json

      - name: Upload release results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-results-${{ github.run_id }}
          path: eval/output/
          retention-days: 365
