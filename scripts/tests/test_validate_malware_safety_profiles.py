from __future__ import annotations

import copy
import importlib.util
import json
import sys
import unittest
from pathlib import Path


ROOT = Path(__file__).resolve().parents[2]
MODULE_PATH = ROOT / "scripts" / "security" / "validate_malware_safety_profiles.py"
SPEC = importlib.util.spec_from_file_location("validate_malware_safety_profiles", MODULE_PATH)
if SPEC is None or SPEC.loader is None:
    raise RuntimeError(f"failed to load module spec from {MODULE_PATH}")
MODULE = importlib.util.module_from_spec(SPEC)
sys.modules[SPEC.name] = MODULE
SPEC.loader.exec_module(MODULE)

PROFILES_PATH = ROOT / "scripts" / "security" / "malware_safety_policy_profiles.json"


class ValidateMalwareSafetyProfilesTest(unittest.TestCase):
    @classmethod
    def setUpClass(cls) -> None:
        cls.payload = json.loads(PROFILES_PATH.read_text(encoding="utf-8"))

    def test_profiles_validate(self) -> None:
        errors = MODULE.validate_profiles(copy.deepcopy(self.payload))
        self.assertEqual(errors, [])

    def test_rejects_cloud_mode(self) -> None:
        payload = copy.deepcopy(self.payload)
        payload["profiles"][0]["policy_mode"] = "cloud"
        errors = MODULE.validate_profiles(payload)
        self.assertTrue(any("unsupported policy_mode" in error for error in errors), errors)

    def test_rejects_allowlist_wildcard(self) -> None:
        payload = copy.deepcopy(self.payload)
        payload["profiles"][1]["allowlisted_endpoints"] = ["*"]
        errors = MODULE.validate_profiles(payload)
        self.assertTrue(any("wildcard endpoint" in error for error in errors), errors)

    def test_rejects_offline_profile_with_endpoints(self) -> None:
        payload = copy.deepcopy(self.payload)
        payload["profiles"][0]["allowlisted_endpoints"] = ["https://api.example.local"]
        errors = MODULE.validate_profiles(payload)
        self.assertTrue(any("offline mode must not declare allowlisted endpoints" in error for error in errors), errors)


if __name__ == "__main__":
    unittest.main()
